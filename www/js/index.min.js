document.addEventListener("deviceready",onDeviceReady,!1);var isSubmissions,pageTitle,muted=!0,noku=new Noku,storage=window.localStorage,PREF_LOAD_COUNT=5,INIT_MEMES=!1,SIGNED_IN=!1,IS_MOD=!1,cb=null,comment_posted=!1;const onDeviceReady=()=>{let e=e=>{console.log(`Open Url${e}`),noku.getMemeIDFromURL(e,(e,t)=>{if(!t)return;let n=NaN;try{n=JSON.parse(e.data).data,n=parseInt(n)}catch(e){return void(n=NaN)}isNaN(n)||(storage.setItem("meme.id",n),redirect("meme.html"))})};window.plugins.webintent.onNewIntent(e),window.plugins.webintent.getUri(e),console.log(`Running cordova-${cordova.platformId}@${cordova.version}`),pageTitle=$(".page-title"),noku.init(),noku.setCredentials(storage.getItem("auth_token"),storage.getItem("uid")),noku.uid&&noku.getThisUser(()=>{noku.userdat=JSON.parse(storage.getItem("userdat")),IS_MOD=noku.userdat.perms>31,console.log(noku.userdat)}),$(".btn").on("click",e=>handleClick(e)),isSubmissions=2===getType(),getValue("em-measure"),noku.testToken(handleTokenCheck)},handleTokenCheck=(e,t)=>{let n;try{n=JSON.parse(e.data)}catch(e){(n={}).valid=!1}SIGNED_IN=!0===n.valid,setup()},redirect=e=>{$("body").fadeOut(100,()=>{window.location.href=e})};var em;const getValue=e=>{var t=document.getElementById(e);return t.style.height="1em",em=t.offsetHeight},handleClick=e=>{var t=$(e.target);let n=t.closest(".swiper-slide");var a=t.data("command");if("refresh"===a&&window.location.reload(!0),"repub"===a&&SIGNED_IN&&repub(),"subscribe"===a&&SIGNED_IN&&subscribe(),"like"===a&&SIGNED_IN&&likeMeme(n,noku),"dislike"===a&&SIGNED_IN&&dislikeMeme(n,noku),"mute"===a&&toggleMute(),"menu-close"===a&&exitMenu(),"menu"===a&&enterMenu(),"profile"===a&&profile(),"submissions"===a&&redirect("submissions.html"),"dank"===a&&redirect("index.html"),"comment"===a){let e=$(".post-comment");e.show(),e.data("replyTo",-1),e.data("meme",n.data("memeid")),comment_posted=!1}if("postcomment"===a){if(comment_posted)return;comment_posted=!0;let e=$(".post-comment"),t=e.data("replyTo"),n=e.data("meme"),a=$(".content").val();noku.postComment(n,a,t,(e,t)=>{let n;try{n=JSON.parse(e.data)}catch(t){(n={}).valid=!1,alert(JSON.stringify(e))}create_posted_comment({id:n.data.id,likes:0,dislikes:0,content:a},0,null,$(".comments")),$(".content").val("")}),e.hide()}"viewprofile"===a&&viewprofile(t.data("id"))},profile=()=>{storage.setItem("view.id",noku.uid),redirect("profile.html")},viewprofile=e=>{storage.setItem("view.id",e),redirect("profile.html")},toggleMute=e=>{muted?($("video").prop("muted",!1),$(".mute-control").css("background-image",'url("../www/img/audio_on.png")'),muted=!1):($("video").prop("muted",!0),$(".mute-control").css("background-image",'url("../www/img/audio_off.png")'),muted=!0)},enterMenu=()=>{$("#sidemenu").css({display:"block"}).addClass("animated slideInRight"),$("#overlay").fadeIn(),$("#menu-close").removeClass("hide")},exitMenu=()=>{let e=$("#sidemenu");e.addClass("animated slideOutRight"),e.css({display:"none"}),$("#overlay").fadeOut(),$("#menu-close").addClass("hide")};var set=0;const buffer=5,setup=()=>{$("body").fadeIn(100,()=>{}),$(".post-comment").hide();var e={direction:"horizontal",autoHeight:!0,loop:!0,effect:"coverflow",zoom:{maxRatio:5}};cb=new ClipboardJS(".meme-share"),"browser"===device.platform&&($(".swiper-container").append('<div class="swiper-button-prev"></div><div class="swiper-button-next"></div>'),e.navigation={nextEl:".swiper-button-next",prevEl:".swiper-button-prev"}),window.mySwipe=new Swiper(".swiper-container",e),noku.checkUpdate(e=>{navigator.notification.confirm(`New: ${e.version}\n`+`Yours: ${noku.version}\n`+"And Update is available to download, would you like to update?",e=>{1===e&&downloadUpdate()},"Update Available!",["Yes","No"])}),loadAllMemes(getType());let t=window.mySwipe;t.on("transitionStart",()=>{this.previousIndex<this.activeIndex?void 0===noku.memes[this.activeIndex-5]||unloadMemeContent(noku.memes[this.activeIndex-5]):void 0===noku.memes[this.activeIndex+5]||unloadMemeContent(noku.memes[this.activeIndex+5]),stop_media(noku.memes[this.previousIndex]),$(".post-comment").hide()}),t.on("transitionEnd",()=>{updatePageTitle(this.activeIndex+1,Object.keys(noku.memes).length);let e=noku.memes[this.activeIndex];for(var t=0;t<11;t++){let e=indexToPos(this.activeIndex,t-5);noku.memes[e].loaded||(createMeme("#slide-"+(this.activeIndex+(t-5))%11,memes[e],5===t),loadMemeContent(noku.memes[e]))}loadComments(e),play_media(e),storage.setItem(isSubmissions?"sub.last":"dank.last",this.activeIndex)})},updatePageTitle=(e,t)=>{pageTitle.html(`${isSubmissions?"Submissions: ":"Dank Memes: "}<span style="font-size: 0.9em;">${e}/${t}</span>`)},downloadUpdate=()=>{window.requestFileSystem(LocalFileSystem.PERSISTENT,0,onFileSystemSuccess=(e=>{let t="";switch(console.log(device.platform),device.platform){case"Android":t="file:///storage/emulated/0/download/";break;case"iOS":t=cordova.file.documentsDirectory}let n=`${t}new-android.apk`,a=new FileTransfer;alert(n),a.download("https://cdn.xemplarsoft.com/app-debug.apk",n,e=>{navigator.notification.alert("To finish updating, navigate to your downloads folder and click new-android.apk",()=>{},"Finishing Steps","Okay")},e=>{alert(`Error downloading the latest updates! - error: ${JSON.stringify(e)}`)})}),e=>{alert(`Download update failed: ${e.code}`)})},loadAllMemes=e=>{noku.getMemes(e,(e,t)=>{console.log(e);const n=window.mySwipe;if(t){var a;try{a=JSON.parse(e.data).data}catch(e){a=[].push(null)}var o=storage.getItem(isSubmissions?"sub.last":"dank.last");null==o&&(o=0),noku.memes=a;for(var i=0;i<a.length;i++)a[i].loaded=!1;for(var d=0;d<11;d++){let e=indexToPos(this.activeIndex,d-5);createMeme("#slide-"+(this.activeIndex+(d-5))%11,a[e],5===d),loadMemeContent(a[e])}n.update(),play_media(noku.memes[o]),n.slideTo(o,0,!0)}else createMeme(".swiper-wrapper",null)})},indexToPos=(e,t)=>e+(t%11-5),loadComments=async e=>{let t=e.id,n=$(".comments");n.html(""),noku.getCommentsByID(t,(e,t)=>{if(t){var a;try{a=JSON.parse(e.data).data}catch(t){console.log(t),console.log(e),alert(JSON.stringify(e)),a=[]}console.log(a);var o=[];for(let e in a)-1===a[e].replyTo&&o.push(a[e]);for(let e in a)-1!==a[e].replyTo&&o.push(a[e]);a=o,o=null;for(let e in a){let t=a[e];if(-1===t.replyTo)t.author===noku.uid?create_posted_comment(t,0,null,n):create_comment(t,0,null,n);else{let e=getCommentByID(a,t.replyTo),n=$(`#comment-${t.replyTo}.comment-replies`),o=$(`#comment-${t.replyTo}.comment-head`);t.author===noku.uid?create_posted_comment(t,o.data("layer")+1,e,n):create_comment(t,o.data("layer")+1,e,n)}}}})},create_comment=(e,t,n,a)=>{let o=e.liked,i=e.disliked,d=`\n        <div class="comment${null==n?" comment-root":""}" id="comment-${e.id}">\n            <div class="comment-content">\n                <div class="comment-head" data-layer="${t}">\n                    <div class="float-left user-data"></div>\n                    <div class="float-right extra"></div>\n                </div>\n                <div class="comment-body">${e.content}</div>\n                <div class="comment-vote"\n                    <div class="float-left">\n                        <div class="comment-like-count" id="comment-count-${e.id}">${e.likes-e.dislikes}</div>\n                        <div class="comment-like btn" data-comment="${e.id}" id="comment-like-${e.id}"></div>\n                        <div class="comment-dislike btn" data-comment="${e.id}" id="comment-dislike-${e.id}></div>\n                    </div>\n                    <div class="float-right">\n                        <div class="comment-reply btn" data-comment="${e.id}"></div>\n                    <div>\n                </div>\n                <div class="comment-overlay"></div>\n            <div>\n            <div class="comment-replies"></div>\n        <div>\n    `;a.prepend(d),o&&($(`#comment-${e.id}.comment-liked`).removeClass("comment-give"),$(`#comment-${e.id}.comment-like`).addClass("comment-given")),i&&($(`#comment-${e.id}.comment-dislike`).removeClass("comment-take"),$(`#comment-${e.id}.comment-dislike`).addClass("comment-taken")),$(`#comment-${e.id} .comment-like`).click(t=>{likeComment(e.id,noku)}),$(`#comment-${e.id} .comment-dislike`).click(t=>{dislikeComment(e.id,noku)}),noku.getUserData(e.author,t=>{let a=noku.getCDNUrl();n&&$(`#comment-${e.id} .extra`).html(`\n                    <div class="comment-reply-to">Reply To</div>\n                    <div class="comment-jump btn" data-comment="${n.id}"></div>\n                    `),$(`#comment-${e.id} .user-data`).html(`          \n                <div class="comment-pfp"><img class="pfp-image" src="${a}${t.pfp}" /></div>          \n                <div class="comment-user" style="color:#${t.color};">${t.username}</div>\n                `),$(`#comment-${e.id} .comment-overlay`).each(()=>{$(this).fadeOut(0)}),$(`#comment-${e.id} .comment-head`).each(()=>{let e=$(this),t=2*e.data("layer")+1,n=t+1;e.css("padding-left",`${2*e.data("layer")}em`),e.css("width",`calc(100% - ${2*e.data("layer")}em)`);let a=e.parent().children(".comment-body");a.css("padding-left",`${t}em`),a.css("width",`calc(100% - ${n}em)`);let o=e.parent().children(".comment-vote");o.css("padding-left",`${t}em`),o.css("width",`calc(100% - ${t}em)`)})})},create_posted_comment=(e,t,n,a)=>{let o=`\n        <div class="comment"${null==n?"comment-root":""}" id="comment-${e.id}">\n            <div class="comment-content">\n                <div class="comment-hear" data-layer="${t}">\n                    <div class="float-left user-data">\n                        <div class="comment-pfp"<img class="pfp-image" src"${noku.getCDNUrl()}${noku.userdat.pfp}" alt=""/></div>\n                        <div class="comment-user" style="color:#${noku.userdat.color};">${noku.userdat.username}</div>\n                    </div>\n                <div class="float-right extra">\n                    ${null!=n?`<div class="comment-reply-to">Reply</div><div class="comment-jump btn" data-comment="${n.id}"></div>`:""}\n                </div>\n            </div>\n            <div class="comment-body">${e.content}</div>\n            <div class="comment-vote">\n                <div class="float-left">\n                    <div class="comment-like-count">${e.likes-e.dislikes}</div>\n                    <div class="comment-like btn" data-comment="${e.id}"></div>\n                    <div class="comment-dislike btn" data-comment="${e.id}"></div>\n                </div>\n                <div class="float-right">\n                    <div class="comment-reply btn" data-comment="${e.id}"></div>\n                </div>\n            </div>\n            <div class="comment-replies"></div>\n        </div>\n    `;a.prepend(o),$(`#comment-${e.id} .comment-overlay`).each(()=>{$(this).fadeOut(0)}),$(`#comment-${e.id} .comment-head`).each(()=>{let e=$(this),t=2*e.data("layer")+1,n=t+1;e.css("padding-left",`${2*e.data("layer")}em`),e.css("width",`calc(100% - ${2*e.data("layer")}em)`);let a=e.parent().children(".comment-body");a.css("padding-left",`${t}em`),a.css("width",`calc(100% - ${n}em)`);let o=e.parent().children(".comment-vote");o.css("padding-left",`${t}em`),o.css("width",`calc(100% - ${t}em)`)}),$(`#comment-${e.id} .comment-jump`).click(()=>{let e=$(this).data("comment"),t=$("#comment-"+e),n=$($("#comment-"+e+" .comment-overlay")[0]),a=$("body, html");a.animate({scrollTop:t.position().top}),a.promise().done(()=>{n.fadeIn(200).fadeOut(200).fadeIn(200).fadeOut(200).fadeIn(200).fadeOut(200)})})},getCommentByID=(e,t)=>{for(let n in e)if(e[n].id===t)return e[n];return null},createNullMeme=e=>{$(e).append('\n            <div class="swiper-slide meme-container" id="NULLMEME" data-memeid="NULLMEME">\n                <div class="meme-op">\n                    <div class="float-left">\n                        <div class="op-pfp"></div>\n                        <div class="op-username">noku team</div>\n                    </div>\n                    <div class="float-right">\n                        <div class="btn btn-black mr-2 my-auto" data-command="none">No touch!</div>\n                    </div>\n                </div>\n                <div class="meme-body swiper-zoom-container">\n                    <div class="container p6">\n                        <h1>End of the line pal!</h1>\n                        <p>Unfortunately, you have reached the end of the meme stream, come back later.</p>\n                    </div>\n                </div>\n                <div class="meme-footer">\n                    <div class="float-left">\n                        <div class="meme-like-count"></div>\n                        <div class="meme-take btn ml-1" data-command="none"></div>\n                        <div class="meme-take btn" data-command="none"></div>\n                    </div>\n                    <div class="float-right"\n                        <div class="meme-take btn mr-1" data-command="none"></div>\n                        <div class="meme-take btn mr-2" data-command="none"></div>\n                        <div class="meme-take btn mr-2" data-command="none"></div>\n                    </div>\n                </div>\n            </div>\n        ')},createMeme=(e,t,n)=>{if(null==t)return createNullMeme(e);let a=t.id,o=t.hash,i=t.liked,d=t.disliked,m=t.author,s=$(e),l=`#${o}`,c=`${noku.getAPIUrl().substring(0,noku.getAPIUrl().length-4)}home/${o}`;s.append(`\n            <div class="meme-container" id="${o}" data-memeid="${a}">\n                <div class="meme-op">\n                    <div class="float-left">\n                        <div class="op-pfp"></div>\n                        <div class="op-username"></div>\n                    </div>\n                    <div class="float-right">\n                        <div class="btn btn-black mr-2 my-auto" data-command="viewprofile" data-id="${m}">View Profile</div>\n                    </div>\n                </div>\n                <div class="meme-footer">\n                    <div class="float-left">\n                        <div class="meme-like-count" id="count-${a}"></div>\n                        ${SIGNED_IN?`<div class="meme-give btn ml-1" data-command="like" id="like-${a}"</div>\n                            <div class="meme-take btn" data-command="dislike" id="dislike-${a}"></div>`:""}\n                    </div>\n                    <div class="float-right"> \n                        ${IS_MOD?'<div class="meme-flag btn mr-1" data-command="flag"></div>':""}\n                        ${SIGNED_IN?'<div class="meme-repub btn mr-1" data-command="repub"></div>':""}\n                        <button class="btn btn-clear meme-share mr-2" data-command="share" data-clipboard-text="${c}"></button>\n                        ${SIGNED_IN?'<div class="meme-comment btn mr-2" data-command="comment"></div>':""}\n                    </div>\n                </div>\n            </div>\n        `),$(`#${o} .meme-share`).on("click",e=>{"browser"===device.platform?alert("Url Copied"):(cordova.plugins.clipboard.copy(c),window.plugins.toast.showWithOptions({message:"Copied URL",duration:"short",position:"bottom",addPixelsY:-40}))}),i&&($(`#like-${a}`).removeClass("meme-give"),$(`#like-${a}`).addClass("meme-given")),d&&($(`#dislike-${a}`).removeClass("meme-take"),$(`#dislike-${a}`).addClass("meme-taken")),"browser"===device.platform||$(`${l} .meme-container`).addClass("center-vertical"),$(".btn").on("click",e=>{handleClick(e)});let r=noku.getCDNUrl(),v=t.author;noku.getUserData(v,e=>{let t=e.pfp;$(`${l} .op-pfp`).html(`<img class="pfp-image" src="${r}${t}" alt=""/>`);let n=$(l+`${l} .op-username`);n.html(e.username),n.css("color",`#${e.color}`)}),$(`${l} .meme-like-count`).html(t.likes-t.dislikes),window.mySwipe.update()},unloadMemeContent=e=>{if(!e.loaded)return;e.loaded=!1;let t=e.hash;$(`${`#${t}`} .meme-body`).html("")},loadMemeContent=e=>{if(e.loaded)return;e.loaded=!0;let t=`#${e.hash}`,n=noku.getCDNUrl();var a=e.mime_type;null!=a&&(a.includes("image")&&$(`${t} .meme-body`).html(`<img class="meme-image swiper-zoom-target" src="${n}${e.hash}"/>`),a.includes("embed")&&noku.getContent(`${n}${e.hash}`,(n,a)=>{a&&("browser"===device.platform?$(`${t} .meme-body`).html(n.data):$(`${t} .meme-body`).html(`<iframe class="meme-embed" src="${noku.getCDNUrl()}${e.hash}" onload="resizeIframe(this)"/>`))}),a.includes("video")&&($(`${t} .meme-body`).html(`<video class="meme-image meme-video swiper-zoom-target" muted loop><source src="${n}${e.hash}" type="${a}"/></video><div class="mute-control btn" data-command="mute"></div>`),$(`${t} .mute-control`).click(()=>{toggleMute(t)})),a.includes("audio")&&($(`${t} .meme-body`).html(`<audio class="meme-image meme-audio" controls><source src="${n}${e.hash}" type="${a}"/></audio>`),$(`${t} .mute-control`).click(()=>{toggleMute(t)})),$(`${t} .meme-image`).one("load",()=>{window.mySwipe.update()}),$(`${t} .meme-video`).on("load",()=>{window.mySwipe.update(),focus&&($(`${t} video`)[0].autoplay=!0),play_media(e)}),window.mySwipe.update())};